#Requires -RunAsAdministrator
function Set-DNSFix{
    $DNSServers = @()
    $servers = Get-ADComputer -Filter 'operatingsystem -like "*server*" -and enabled -eq "true"' `
-Properties Name,Operatingsystem,OperatingSystemVersion,IPv4Address |
Sort-Object -Property Operatingsystem |
Select-Object -Property Name,Operatingsystem,OperatingSystemVersion,IPv4Address

foreach($server in $servers){
    $Name = $server.name
    $IP = $server.IPv4Address
    write-output "Processing Server: $Name - $IP"
    try{
        $DNSTest = Test-DnsServer -Computername $Name -IPAddress 8.8.8.8
        }catch{
        #ignore errors
        }
    $DNSResult = $DNSTest.Result
    if($DNSResult -eq "Success"){
        #write-output "Added to DNS Server List"
        $DNSServers += "$Name`r"
        }
    }

$credential = Get-Credential -Message "Enter Administrator Credentials to connect to servers"

foreach($DNSServer in $DNSServers){
    $DNSFix = New-PSSession -ComputerName $DNSServer -Credential $credential
        Invoke-Command -Session $DNSFix -Scriptblock {
            $registryPath = "HKLM:\System\CurrentControlSet\Services\DNS\Parameters"
            $Name = "TcpReceivePacketSize"
            $value = "0x0000FF00"
            New-ItemProperty -Path $registryPath -Name $name -Value $value -PropertyType DWORD -Force | Out-Null
            Restart-Service -Name DNS
            Get-ItemProperty $registryPath -name $name
    }
    #Remove-PSSession $DNSFix.ID
}
Get-Variable -Exclude PWD,*Preference | Remove-Variable -EA 0
}